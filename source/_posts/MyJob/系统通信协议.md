---
title: 系统通信协议
date: 2017-03-20 21:04:04
tags: MyJob 
categories: MyJob

---


#系统通信协议

## 红外接口协议

串口通信协议拟采用格式
如下表1：
&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;表1 串口通信协议

|数据帧起始标识|数据长度|EPD仪器编号|EPD使用人编号|中转器编号|计算机编号|设备类型|命令|子命令|附加数据|校验|数据帧结束标识|
|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|
|两个字节|两个字节|4个字节|4个字节|2个字节|2个字节|1个字节|2个字节|1个字节|小于65536|两个字节|两个字节|

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;表2串口通信协议

|数据帧起始标识|数据长度|EPD仪器编号|EPD使用人编号|中转器编号|计算机编号|设备类型|命令|子命令|附加数据|校验|数据帧结束标识|
|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|
|0xAA 0x55|	两个字节|	4个字节|	4个字节|	2个字节|2个字节|1个字节|	2个字节|	1个字节|	小于65536|	CRC16|	0XBB 0x66|

&emsp;&emsp;当附加数据中或命令中出现0xAA 0x55数据时，则CRC16和数据长度综合判断命令是否正确。计算个数为数据长度，指示EPD仪器编号至附加数据部分长度。EPD仪器编号从1至最大值。中转器编号从1至最大值。设备类型描述数据流从哪类设备流出，设备类型：1表示EPD->>g中转器，2表示中转器->>EPD，3为中转器->>服务器，4为服务器->>中转器，5为EPD->>服务器，6为服务器->>EPD。命令是每次传输，其功能类型编号，在后续中编号实现。附加数据则根据命令编号，对应其相应数据。
&emsp;&emsp;EPD插入中转器红外窗口，中转器主动发应答信号，当识别到有仪器时，则等待其输入身份代码，合格通过后，开始配置。身份代码通过中转器上传至服务器，在服务器上进行核实。

### 仪器设置
#### 应答信号

&emsp;&emsp;数据中转器和个人剂量仪之间采用应答式方式，每收到一个正确的命令后，回复一个Ack信号，采用一问一答方式。
**数据长度为**
`4+4+2+2+1+2+1+1=17`
**命令** 
`0x00 0x01`
**附加数据为** 
`0x00`

#### 剂量阈值设置
**数据长度**
`4+4+2+2+1+2+1+3=19`
**命令**
`0x00 0x02` 
**附加数据**
`数值*1uSv`  `3个字节`。
	
#### 剂量率阈值设置
**数据长度**
`4+4+2+2+1+2+1+3=19`
**命令**
`0x00 0x03` 
**附加数据**
`数值*1uSv/h`  `3个字节`

#### 间隔时间存储设置
**数据长度**
`4+4+2+2+1+2+1+3=19`
**命令**
`0x00 0x04` 
**附加数据**
`数值*1分钟`  `3个字节`

#### 仪器编号设置
**数据长度**
`4+4+2+2+1+2+1+1=17`
**命令**
`0x00 0x05` 
**附加数据**
`0x00`  `1个字节`

#### 仪器刻度系数设置
**数据长度**
`4+4+2+2+1+2+1+1=17`
**命令**
`0x00 0x06` 
**附加数据**
`0x00`  `1个字节`

#### 时间定时设置
 
**数据长度**
`4+4+2+2+1+2+1+4=20`
**命令**
`0x00 0x08` 
**附加数据**
`时间设定按秒计算`  `4个字节`

#### 累积剂量清零
 
**数据长度**
`4+4+2+2+1+2+1+1=17`
**命令**
`0x00 0x09` 
**附加数据**
`0x00`  `1个字节`

#### 仪器日期设定
 
**数据长度**
`4+4+2+2+1+2+1+7=23`
**命令**
`0x00 0x0B` 
**附加数据**
`年，月，日，时，分，秒。年2个字节，其它都是1个字节`  `7个字节`

### 仪器读取
#### 间隔时间累积剂量读取
 
**命令**
`0x08 0x01` 
**附加数据**
`0x00`

#### 累积剂量读取
 
**命令**
`0x08 0x02` 
**附加数据**
`0x00`

#### 最大剂量率读取
 
**命令**
`0x08 0x03` 
**附加数据**
`0x00`

#### 仪器编号读取
 
**命令**
`0x08 0x04` 
**附加数据**
`0x00`

#### 超量程标识读取
 
**命令**
`0x08 0x05` 
**附加数据**
`0x00`

#### 计数读取
 
**命令**
`0x08 0x06` 
**附加数据**
`0x00`

#### 剂量阈值
 
**命令**
`0x08 0x07` 
**附加数据**
`0x00`

#### 剂量率阈值
 
**命令**
`0x08 0x08` 
**附加数据**
`0x00`

#### 刻度系数读取
 
**命令**
`0x08 0x09` 
**附加数据**
`0x00`

#### 仪器日期读取
 
**命令**
`0x08 0x0A` 
**附加数据**
`0x00`

#### 间隔时间读取
 
**命令**
`0x08 0x0B` 
**附加数据**
`0x00`


## 服务器接口协议

&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;表2串口通信协议

|数据帧起始标识|数据长度|EPD仪器编号|EPD使用人编号|中转器编号|计算机编号|设备类型|命令|子命令|附加数据|校验|数据帧结束标识|
|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|
|0xAA 0x55|	两个字节|	4个字节|	4个字节|	2个字节|2个字节|1个字节|	2个字节|	1个字节|	小于65536|	CRC16|	0XBB 0x66|


### 人员查询 
 

#### 查询命令
**命令**
`0xAA 0x0A` 
**附加数据**
`0x00`
#### 查询应答
查询成功：`0xAA 0x01`
传输错误：`0xAA 0xBB`
人员查询错误：`0xAA 0xB1`
不能参加辐射工作：`0xAA 0xB2`
下达命令收据包：
`2303,R2015120005,检测任务06,0.02,0.5;2299,R2016030001,监测任务02,0.02,0.5;2305,R2015120006,检测任务07,0.02,0.5;2302,R2015120004,检测任务05,0.02,0.05;2300,R2016030002,监测任务03,0.02,0.05;2304,R2015120002,检测任务06,0.01,0.01;2309, R20151200011,检测任务11,0.01,0.01;2306,R2015120006,检测任务08,0.01,0.01;2301,R2016030003,监测任务04,0.01,0.01;2308,R2015120010,检测任务10,0.01,0.01;2307,R2015120009,检测任务09,0.01,0.01;1585,R2015120001,检测任务01,0.01,0.01;Young,2016-04-19 14:08:57,, , ;`

### 插入进入记录 
 

#### 插入进入记录命令
**命令**
`0xAA 0x0B` 
**附加数据**
`2015-10-20 15:00:00` `,` `517` `任务ID`

#### 进入确定
**命令**
`0xAA 0xBD`

### 离开记录 
 

#### 插入离开记录命令
**命令**
`0xAA 0x0C` 
**附加数据格式**

 `间隔时间`  `.`  `时间`  `,`  `'剂量值'`  `,`  `'最大剂量率'`  `,`  `最大剂量率时间`  `,`  `'记录条数'`  `,`  `'间隔时间'`  `;`  `'子记录';'子记录';......` 

`3.2016-04-13 15:30:30,’0.05’,’0.1’,’2’,’2’;’0.05’;’0.05’;`

#### 查询应答
查询成功：`0xAA 0x01`
传输错误：`0xAA 0xBB`
人员离开错误：`0xAA 0xB3`
插入错误：`0xAA 0xB4`


